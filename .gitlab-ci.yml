include:
  - project: o/infra/templates
    file: /gitlab-ci/includes/jobs.yaml

Tests:
  stage: test
  coverage: /All\sfiles.*?\s+(\d+.\d+)/
  image: strapi/base:14-alpine
  variables:
    POSTGRES_HOST: timescale__timescaledb
    POSTGRES_PORT: 5432
    POSTGRES_DB: strapi_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: password
    POSTGRES_HOST_AUTH_METHOD: trust
    TZ: Europe/Zurich
  services:
    - timescale/timescaledb:latest-pg12
  only:
    - merge_requests
    - master
    - main
  cache:
    key: node_modules
    paths:
      - backend/node_modules
  script:
    - echo "45.66.221.1 npm-8ee.hidora.com" >> /etc/hosts
    - cd backend
    - yarn
    - yarn test:ci

Deploy Test:
  extends: .deployHidora
  rules:
    - if: '$CI_COMMIT_REF_NAME == "master"'
  environment:
    name: Test
    url: "https://caroster-dev.hidora.com"

Deploy to Prod:
  extends: .deployHidora
  rules:
    - if: "$CI_COMMIT_TAG =~ /v.*$/"
      when: manual
  environment:
    name: Prod
    url: https://app.caroster.io
